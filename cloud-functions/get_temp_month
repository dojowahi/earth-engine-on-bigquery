import json
import ee
from datetime import date, datetime, timedelta


def get_temp_month(request):
      service_account = 'xxxx-xxxx-xxxx@appspot.gserviceaccount.com'
      credentials = ee.ServiceAccountCredentials(service_account, 'eeKey.json')
      ee.Initialize(credentials=credentials, project='xxxx-xxxx-xxxxx')
      request_json = request.get_json(silent=True)
      replies = []
      calls = request_json['calls']
      for call in calls:
        farm_lon = call[0]
        farm_lat = call[1]
        farm_name = call[2]
        farm_year = call[3]
        farm_mon = call[4]
        
        farm_poi = (farm_lon,farm_lat)

        ee_temp = farm_temp_calc(farm_poi,farm_year,farm_mon)
        farm_temp = ee_temp.getInfo()

        replies.append({
          'farm_name': f'{farm_name}',
          'farm_temp': f'{farm_temp}'
        })
      return json.dumps({
        'replies': [json.dumps(reply) for reply in replies]
      })



def farm_temp_calc(farm_poi,year,month):
  

  first_date = datetime(year, month, 1)
  startDate = first_date.strftime("%Y-%m-%d")
  last_date = datetime(year, month + 1, 1) + timedelta(days=-1)
  endDate = last_date.strftime("%Y-%m-%d")
  terra = terra = ee.ImageCollection("IDAHO_EPSCOR/TERRACLIMATE")
  tmaxScaled = terra.filter(ee.Filter.date(startDate, endDate)).mean().select('tmmx').multiply(0.1)
  poi = ee.Geometry.Point(farm_poi)

  tempValue = tmaxScaled.reduceRegion(**{
    'geometry': poi,
    'reducer': ee.Reducer.mean(),
    'scale': 30
  }).get('tmmx'); 
  return tempValue
